# BS OAuth2登录插件

## 插件介绍

这是一款ShopXO电商系统的插件，用于支持第三方自定义OAuth2登录功能。通过配置，用户可以使用任何支持OAuth2协议的第三方平台账号快速登录ShopXO系统。

## 功能特性

- 支持自定义OAuth2应用配置
- 灵活配置授权URL、Token URL、用户信息URL等参数
- 支持自定义用户信息字段映射
- 支持中英文语言切换
- 提供后台配置界面和前端登录入口
- 自动处理用户注册和登录流程
- 完善的日志记录和错误处理机制
- 增强的URL生成和验证功能

## 安装说明

1. 将插件文件夹 `bs_oauth2` 上传到ShopXO系统的 `app/plugins/` 目录下
2. 登录ShopXO后台，进入"应用 -> 应用管理"页面
3. 找到"自定义OAuth2登录"插件，点击"安装"按钮
4. 安装完成后，点击"配置"按钮进入配置页面

## 配置说明

在插件配置页面，您需要填写以下信息：

1. **应用ID**：第三方OAuth2应用的Client ID（必填）
2. **应用密钥**：第三方OAuth2应用的Client Secret（必填）
3. **授权URL**：第三方OAuth2应用的授权地址，必须以http://或https://开头（必填）
4. **Token URL**：第三方OAuth2应用的获取Token地址（必填）
5. **用户信息URL**：第三方OAuth2应用的获取用户信息地址（必填）
6. **权限范围**：请求的权限范围，多个用空格分隔，默认值为"openid profile email"
7. **用户ID字段**：用户信息中唯一标识用户的字段名，默认为"id"
8. **用户名字段**：用户信息中用户名的字段名，默认为"username"
9. **邮箱字段**：用户信息中邮箱的字段名，默认为"email"
10. **启用状态**：必须设置为启用（1）才能使用插件功能

配置完成后，点击"保存配置"按钮保存设置。

## 使用方法

### 方法一：直接访问插件页面

访问以下链接进入OAuth2登录页面：
```
https://您的域名/?s=plugins/index/pluginsname/bs_oauth2/pluginscontrol/index/pluginsaction/index.html
```
然后点击"OAuth2登录"按钮。

### 方法二：在其他页面嵌入登录按钮

```html
<a href="{:PluginsHomeUrl('bs_oauth2', 'index', 'login')}" class="your-button-class">OAuth2账号登录</a>
```

### 方法三：直接调用登录接口

```
https://您的域名/?s=plugins/index/pluginsname/bs_oauth2/pluginscontrol/index/pluginsaction/login.html
```

## 回调地址配置

请确保在第三方OAuth2应用中正确配置回调地址为：
```
https://您的域名/?s=plugins/index/pluginsname/bs_oauth2/pluginscontrol/index/pluginsaction/callback.html
```

## 日志记录

插件提供详细的日志记录功能，日志文件位于：
```
runtime/log/plugins/bs_oauth2/oauth2_YYYY-MM-DD.log
```

通过查看日志文件，可以帮助排查登录过程中遇到的各种问题。

## 常见问题排查

### 问题一：点击登录链接后页面没有内容或无跳转

**可能原因及解决方案：**

1. **插件未启用**
   - 检查后台配置中插件状态是否设置为"启用"
   - 尝试重启插件（先禁用再启用）

2. **配置不完整**
   - 确保所有必填字段都已填写
   - 检查授权URL是否以http://或https://开头

3. **配置错误**
   - 检查app_id、authorize_url等关键配置是否正确
   - 查看日志文件中是否有相关错误信息

4. **服务器环境问题**
   - 检查服务器是否支持curl函数
   - 确认服务器可以访问外部OAuth2服务

### 问题二：跳转到第三方授权页面失败

**解决方案：**
- 验证授权URL格式是否正确
- 检查app_id配置是否正确
- 查看日志文件中的详细错误信息

### 问题三：授权成功后无法返回网站

**解决方案：**
- 确认在第三方平台正确配置了回调地址
- 检查回调地址格式是否符合要求
- 验证服务器防火墙是否允许回调请求

### 问题四：返回网站后登录失败

**解决方案：**
- 检查token_url和user_info_url配置
- 确认用户信息字段映射设置正确
- 查看日志文件中的错误详情

## 故障排除步骤

1. **检查插件状态**
   - 确认插件已安装并启用
   - 检查配置信息是否完整正确

2. **查看日志文件**
   - 分析日志中的错误信息和警告
   - 关注URL生成、配置验证等关键步骤

3. **测试网络连接**
   - 确保服务器可以访问OAuth2服务提供商
   - 检查防火墙设置是否阻止了请求

4. **验证回调地址**
   - 确认回调地址已在第三方平台注册
   - 测试回调地址是否可以正常访问

5. **检查PHP环境**
   - 确保PHP版本兼容性
   - 验证curl扩展是否已安装和启用

## 技术支持

如遇到无法解决的问题，请提供以下信息寻求帮助：

1. 完整的日志文件内容
2. 插件配置信息（请隐藏敏感信息如app_secret）
3. 具体的错误现象描述
4. ShopXO系统版本
5. PHP环境信息
3. 如果第三方OAuth2接口有特殊要求，请根据实际情况调整配置
4. 首次使用前，请点击"测试连接"按钮确保配置正确

## 常见问题

1. **登录失败提示"Invalid state parameter"**
   - 这通常是由于CSRF保护机制触发，可能是因为会话过期或多次点击登录按钮导致
   - 解决方案：刷新页面后重新尝试登录

2. **登录失败提示"Failed to get access token"**
   - 这通常是由于应用ID、应用密钥或Token URL配置错误导致
   - 解决方案：检查并修正相关配置

3. **登录失败提示"Failed to get user information"**
   - 这通常是由于用户信息URL配置错误或Token无效导致
   - 解决方案：检查并修正用户信息URL配置

## 更新日志

### 1.0.0
- 首次发布，支持基本的OAuth2登录功能
- 提供完整的配置选项和用户界面
- 支持用户自动注册和登录

## 技术支持

如果您在使用过程中遇到问题，请联系插件开发者获取技术支持。

开发者：开发者 2816301852@qq.com
